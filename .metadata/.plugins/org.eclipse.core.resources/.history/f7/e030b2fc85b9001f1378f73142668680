/*
 * activity_tracking.h
 *
 *  Created on: Dec 12, 2024
 *      Author: utente
 */

#ifndef INC_ACTIVITY_TRACKING_H_
#define INC_ACTIVITY_TRACKING_H_

#include "main.h"
#include "led.h"

#define STEP_THRESHOLD 300     		//Treshold necessary to evaluate steps (<500 piede alzato, >500 piede abbasato)

#define RUNNING_THRESHOLD 500
#define WALKING_THRESHOLD 1000
#define STANDING_THRESHOLD 1500


//This enum is used in order to save the current state detected.
typedef enum {
    RESTING,
    WALKING,
    RUNNING
}UserState;

typedef struct {
    float data;               // Dato letto dal sensore FSR
    uint8_t foot_on_ground;   // Stato del piede (0 = sollevato, 1 = a terra)
} FSR_Sensor;

typedef struct {
    uint32_t steps;           // Numero totale di passi
    uint32_t last_step_time;  // Tempo dell'ultimo passo rilevato (in millisecondi)
    FSR_Sensor left_foot;     // Sensore FSR per il piede sinistro
    FSR_Sensor right_foot;    // Sensore FSR per il piede destro
} UserActivity;


typedef struct {
    uint32_t *steps;          // Puntatore all'array che contiene i tempi tra i passi
    int8_t index;             // Indice dell'ultimo passo inserito
    uint32_t total_step_time; // Somma dei tempi contenuti nel buffer
    uint32_t length;          // Lunghezza dell'array (buffer size)
} StepBuffer;

void init_fsr_sensor(FSR_Sensor *foot);
void UserActivity_init(UserActivity *user_activity);
void StepBuffer_init(StepBuffer *buffer, uint32_t length);
void read_forceSensor(uint16_t *d_out, FSR_Sensor *sensor);
void update_step_count(UserActivity *user_activity, uint32_t current_time, StepBuffer *step_buffer);
void add_step_time(StepBuffer *buffer, uint32_t step_time);
void determine_activity(StepBuffer *step_buffer);
const char* userState_to_string(UserState state);

#endif /* INC_ACTIVITY_TRACKING_H_ */




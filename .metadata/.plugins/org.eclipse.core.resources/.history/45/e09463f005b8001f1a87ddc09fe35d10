/*
 * read_temperature.c
 *
 *  Created on: Dec 5, 2024
 *      Author: utente
 */

#include "read_temperature.h"
#include <math.h>
#include <stdio.h>

void init_TemperatureParams(TempParam *tempParam){

	tempParam->currentTemperature = 0.0;
	tempParam->previousTemperature = 0.0;
	tempParam->stableTemperature = 0.0;
	tempParam->isStable = 0;
	tempParam->stabilityCounter = 0;
	tempParam->variationDetected = 0;

}

double calculate_Temperature(uint16_t d_out) {
    d
	ouble voltage = ((double)d_out) * VREF / LEVELS;
    double resistance = (-RS * (voltage)) / (voltage - VREF);

    // Calcola la temperatura a partire dalla resistenza
    return (BETA) / (log(resistance / R0) + BETA / T0) - 273.15;
}


void read_Temperature(TempParam *tempParam, uint16_t d_out) {

	double voltage, resistance;
    voltage = ((double)d_out) * VREF / LEVELS;
    resistance = (-RS * (voltage)) / (voltage - VREF);

    tempParam->currentTemperature = (BETA) / (log(resistance / R0) + BETA / T0) - 273.15;

    // Verifica della stabilità
    if (fabs(tempParam->currentTemperature - tempParam->previousTemperature) > STABILITY_THRESHOLD) {
        if (!tempParam->variationDetected) {
            tempParam->variationDetected = 1;
            tempParam->isStable = 0; // Segnala che la temperatura non è stabile
        }

        tempParam->stabilityCounter = 0;
    } else {
        if (tempParam->variationDetected) {
            tempParam->stabilityCounter++;

            if (tempParam->stabilityCounter >= STABILITY_SAMPLES) {
                if (fabs(tempParam->currentTemperature - tempParam->stableTemperature) > STABILITY_THRESHOLD) {
                    tempParam->stableTemperature = tempParam->currentTemperature;
                }
                tempParam->variationDetected = 0;
                tempParam->isStable = 1;
            }
        }
    }

    tempParam->previousTemperature = tempParam->currentTemperature;

}

void reset_TemperatureParams(TempParam *tempParam){

	tempParam->currentTemperature = 0.0;
	tempParam->previousTemperature = 0.0;
	tempParam->stableTemperature = 0.0;
	tempParam->isStable = 0;
	tempParam->stabilityCounter = 0;
	tempParam->variationDetected = 0;

}



